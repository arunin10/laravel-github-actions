name: Deploy to Windows Server (Windows Runner)

on:
  push:
    branches:
      - master  # or 'main'

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create .ssh directory
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.ssh

      - name: Decode and write SSH key
        run: |
          $privateKey = "${{ secrets.DEPLOY_KEY_BASE64 }}"
          $bytes = [System.Convert]::FromBase64String($privateKey)
          [System.IO.File]::WriteAllBytes("$env:USERPROFILE\.ssh\id_ed25519", $bytes)
          icacls "$env:USERPROFILE\.ssh\id_ed25519" /inheritance:r /grant:r "$($env:USERNAME):R"

      - name: Add known_hosts entry
        run: |
          ssh-keyscan -H ${{ secrets.WINDOWS_HOST }} >> "$env:USERPROFILE\.ssh\known_hosts"

      - name: Zip project
        run: |
          Compress-Archive -Path * -DestinationPath laravel.zip -Force

      - name: Copy zip to remote server via SCP
        run: |
          scp -i "$env:USERPROFILE\.ssh\id_ed25519" -o StrictHostKeyChecking=no laravel.zip ${{ secrets.WINDOWS_USER }}@${{ secrets.WINDOWS_HOST }}:~

      - name: Unzip on remote server
        run: |
          ssh -i "$env:USERPROFILE\.ssh\id_ed25519" ${{ secrets.WINDOWS_USER }}@${{ secrets.WINDOWS_HOST }} "powershell -Command Expand-Archive -Path '$env:USERPROFILE\laravel.zip' -DestinationPath '${{ secrets.REMOTE_PATH }}' -Force"
